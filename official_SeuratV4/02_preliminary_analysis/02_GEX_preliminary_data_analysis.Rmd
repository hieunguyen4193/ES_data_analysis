---
title: "Preliminary analysis: `r params$sample.id`"
author:
  - "trnguyen@ukaachen.de"
date: "Last update on `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    keep_md: no
    df_print: paged
    toc: true
    toc_float:
      toc_collapsed: false
    toc_depth: 3
    number_sections: true
    theme: lumen
params:
  PROJECT: NA
  sample.id: NA
  outdir: NA
---


```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
```

<style type="text/css">
    div.datatables { height: auto !important;}
</style>

**Filters:**

- `% mitochondrial <= 10%`

- `% Ambient RNA <= 50%`

**Note 1: In this analysis, firstly, we applied the filters on `% mitochondrial and Ambient RNA contamination`. Then, we remove cells classified as `Doublet` Hashtag Antibodies 1, 2, 3. **

**Note 2: After performing quality control on the Hashtag Antibodies data, we temporarily choose the following quantile for assigning a cell `Singlet`, `Doublet` or `Negative`**: 

- Sample `r params$sample.id``: quantile 0.95

**Note 3: No cell-cycle scores were regressed out**



```{r echo=FALSE, warning=FALSE, message=FALSE, results='hide', fig.width=20, fig.height=12}
#####----------------------------------------------------------------------#####
#
# trnguyen@ukaachen.de
#
#####----------------------------------------------------------------------#####

##### clean up #####
# gc()
# rm(list = ls())

scrna_pipeline_src <- "/home/hieunguyen/CRC1382/src_2023/src_pipeline/scRNA_GEX_pipeline/processes_src"
source(file.path(scrna_pipeline_src, "import_libraries.R"))
source(file.path(scrna_pipeline_src, "helper_functions.R"))
source(file.path(scrna_pipeline_src, "s8_integration_and_clustering.R"))
#####----------------------------------------------------------------------#####
# CONFIGURATIONS 
#####----------------------------------------------------------------------#####
analysis.round <- "1st"
chosen.seed <- 42
num.dim.integration <- 25 
num.PCA <- 25
num.dim.cluster <- 25
num.PC.used.in.Clustering <- 25
num.PC.used.in.UMAP <- 25
my_random_seed <- 42

#####----------------------------------------------------------------------#####
##### input arguments
#####----------------------------------------------------------------------#####
PROJECT <- params$PROJECT
sample.id <- params$sample.id
outdir <- params$outdir
# 
# outdir <- "/media/hieunguyen/CRC1382H/CRC1382/outdir"
# PROJECT <- "EStange_20240411_SeuratV4"
# sample.id <- "d4_LPS"

path.to.main.input <- file.path(outdir, PROJECT)

s.obj <- readRDS(file.path(path.to.main.input, sprintf("%s_round", analysis.round), sprintf("%s_1st_round", sample.id), "s8a_output", sprintf("%s.output.s8a.rds", PROJECT)))

raw.s.obj <- readRDS(file.path(path.to.main.input,sprintf("%s_round", analysis.round), sprintf("%s_1st_round", sample.id), "s1_output", sprintf("%s.output.s1.rds", PROJECT)))

# path.to.main.output <- file.path(path.to.main.input, "data_analysis")
path.to.main.output <- file.path(outdir, PROJECT, "data_analysis")

path.to.01.output <- file.path(path.to.main.output, "01_output")
path.to.02.output <- file.path(path.to.main.output, "02_output", sample.id)
dir.create(path.to.02.output, showWarnings = FALSE, recursive = TRUE)

hashtag.123 <- read.csv(file.path(path.to.01.output, sprintf("Hashtag_123_summary_table_Sample_%s.csv", sample.id)))
hashtag.others <- read.csv(file.path(path.to.01.output, sprintf("Hashtag_others_summary_table_Sample_%s.csv", sample.id)))
```


```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
##### Add ADT information to the main Seurat object s.obj

# Hashtag 1,2,3 (mouse 1 2 3)
s.obj.metadata <- s.obj@meta.data

s.obj.metadata <- merge(s.obj.metadata, hashtag.123, by.x = 0, by.y = "X")

s.obj <- AddMetaData(object = s.obj, metadata = s.obj.metadata$HTO_classification.global, col.name = "HTO_classification.global")
s.obj <- AddMetaData(object = s.obj, metadata = s.obj.metadata$HTO_classification, col.name = "HTO_classification")

doublet.cells <- names(s.obj$HTO_classification.global[s.obj$HTO_classification.global == "Doublet"])
negative.cells <- names(s.obj$HTO_classification.global[s.obj$HTO_classification.global == "Negative"])
singlet.cells <- names(s.obj$HTO_classification.global[s.obj$HTO_classification.global == "Singlet"])
ht1.cells <- names(s.obj$HTO_classification[s.obj$HTO_classification == "Hashtag1-TotalSeqC"])
ht2.cells <- names(s.obj$HTO_classification[s.obj$HTO_classification == "Hashtag2-TotalSeqC"])
ht3.cells <- names(s.obj$HTO_classification[s.obj$HTO_classification == "Hashtag3-TotalSeqC"])
```


```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
# Other hashtags
s.obj.metadata <- s.obj@meta.data

subset.hashtag.others <- subset(hashtag.others, select = c(X, HTO_classification, HTO_classification.global))
colnames(subset.hashtag.others) <- c("X", "HTO.others_classification", "HTO.others_classification.global")

s.obj.metadata <- merge(s.obj.metadata, subset.hashtag.others, by.x = 0, by.y = "X")

s.obj <- AddMetaData(object = s.obj, 
                     metadata = s.obj.metadata$HTO.others_classification, 
                     col.name = "HTO.others_classification")
s.obj <- AddMetaData(object = s.obj, 
                     metadata = s.obj.metadata$HTO.others_classification.global, 
                     col.name = "HTO.others_classification.global")
```

# Number of cells: Raw and after filtering by `% mitochondrial` and `% ambient RNA`

Filters:

- The percentage of mitochondrial mapped reads less than 10%

- The percentage of estimate ambient contamination RNA less than 50%.

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
print(sprintf("Number of cells before filtering: %s", length(colnames(raw.s.obj))))
```


```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
print(sprintf("Number of cells after filtering: %s", length(colnames(s.obj))))
```


```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
filtered.cells <- setdiff(colnames(raw.s.obj), colnames(s.obj))
print(sprintf("Number of removed cells by these filters: %s", length(filtered.cells)))
```

# Number of cells after filtering by `doublet hashtag cells`

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
print(sprintf("Number of removed hashtag-doublet cells: %s", length(colnames(subset(s.obj, HTO_classification.global == "Doublet")))))
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
s.obj.before.remove.by.ht <- s.obj
s.obj <- subset(s.obj, HTO_classification.global != "Doublet")
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
print(sprintf("Number of cells left after filtering by hashtag-doublet: %s", length(colnames(s.obj))))
```

# Preprocessing and QC
## Raw data Quality control  {.tabset}
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
for (plot.name in names(s.obj@misc$all.QC)){
 
    cat('###',plot.name,'{.unlisted .unnumbered} \n')
    
    ##### 
    # plots or tables that we want to show in tabs
    #####
    print(s.obj@misc$all.QC[plot.name])
    cat(' \n \n')
}
```



## Ambient RNA background correction 

### DecontX clusters {.tabset}
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
for (plot.name in names(s.obj@misc$ambient.cluster.RNA.plot)){
 
    cat('####',plot.name,'{.unlisted .unnumbered} \n')
    
    ##### 
    # plots or tables that we want to show in tabs
    #####
    print(s.obj@misc$ambient.cluster.RNA.plot[plot.name])
    cat(' \n \n')
}
```

### Contamination level in each sample

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
ggplot(s.obj@meta.data, aes(x=name, y=AmbientRNA)) + 
  geom_boxplot()

```


### Ambient RNA contamination level {.tabset}

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
for (plot.name in names(s.obj@misc$ambient.contamination.plot)){
 
    cat('####',plot.name,'{.unlisted .unnumbered} \n')
    
    ##### 
    # plots or tables that we want to show in tabs
    #####
    print(s.obj@misc$ambient.contamination.plot[plot.name])
    cat(' \n \n')
}
```


## Descriptive statistics and filtering threshold {.tabset}
This section is devoted to the descriptive statistics of the following varialbes: `nFeature_RNA, nCount_RNA, percent.mt, percent.ribo`. 

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
for (plot.item in c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.ribo")){
  boxplot <- s.obj@meta.data %>% ggplot(aes_string(x = "name", y = plot.item)) +
    geom_boxplot(outlier.colour="black", outlier.shape=16,
               outlier.size=2, notch=FALSE) +
    ggtitle(sprintf("Boxplot: Distribution of %s in each dataset", plot.item))
  cat('###', plot.item,'{.unlisted .unnumbered} \n')
    
    ##### 
    # plots or tables that we want to show in tabs
    #####
  
  print(boxplot)
  
  cat(' \n \n')
}
```



## Descriptive statistics + UMAP {.tabset}

### % Mitochondrial
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
FeaturePlot(object = s.obj, reduction = "RNA_UMAP", feature = "percent.mt", label = TRUE, label.size = 8, pt.size = 0.5, label.color = "red", )
```

### % Ribosome
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
FeaturePlot(object = s.obj, reduction = "RNA_UMAP", feature = "percent.ribo", label = TRUE, label.size = 8, pt.size = 0.5, label.color = "red", )
```

### % nCount RNA
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
FeaturePlot(object = s.obj, reduction = "RNA_UMAP", feature = "nCount_RNA", label = TRUE, label.size = 8, pt.size = 0.5, label.color = "red", )
```

### % nGenes 
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
FeaturePlot(object = s.obj, reduction = "RNA_UMAP", feature = "nFeature_RNA", label = TRUE, label.size = 8, pt.size = 0.5, label.color = "red", )
```

## Cell cycle scoring {.tabset}

### Cell cycle, split by Phase
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
DimPlot(s.obj, reduction = "RNA_UMAP", split.by = "Phase")
```

### Cell cycle, group by Phase
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
DimPlot(s.obj, reduction = "RNA_UMAP", group.by = "Phase", label = TRUE, label.size = 8, pt.size = 0.5, label.box = TRUE, repel = TRUE)
```

### PCA, cell cycle, group by Phase
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
all.genes <- rownames(x = s.obj)
s.genes <- paste0("^", cc.genes$s.genes, "$", collapse = "|")
s.genes <- all.genes[grepl(s.genes, all.genes, ignore.case = TRUE)]
g2m.genes <- paste0("^", cc.genes$g2m.genes, "$", collapse = "|")
g2m.genes <- all.genes[grepl(g2m.genes, all.genes, ignore.case = TRUE)]
s.obj <- RunPCA(s.obj, features = c(s.genes, g2m.genes), nfeatures.print = 10, reduction.name="CELLCYCLED_PCA")

DimPlot(s.obj, reduction = "CELLCYCLED_PCA", group.by = "Phase", pt.size = 1)
```

# Dimension reduction with UMAP

## UMAP: highlight `Doublet`, `Negative` and `Singlet` cells (Hashtag 1, 2, 3) 

**Note: The number of cells in each hashtag here are different from the report ** `01_count_cells_with_hashtags_Sample_adult.html` **since there are some cells removed by the filters on mitochondrial and Ambient RNA**.

### Hashtags of removed cells by mitochondrial + ambientRNA filters

#### Negative, doublet or singlet
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
filtered.cells.hashtag.123 <- subset(hashtag.123, hashtag.123$X %in% filtered.cells)

filtered.cells.hashtag.123 %>% subset(select = c(HTO_classification.global)) %>% table() %>% as.data.frame() %>% create_dt()
```


#### Hashtag 1, 2, 3
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
filtered.cells.hashtag.123 %>% subset(HTO_classification.global == "Singlet") %>% subset(select = c(HTO_classification)) %>% table() %>% as.data.frame() %>% create_dt()
```

### Doublet
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
print(sprintf("Number of Doublet cells: %s", length(doublet.cells)))
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
DimPlot(object = s.obj.before.remove.by.ht, reduction = "RNA_UMAP", label = TRUE, label.box = TRUE, label.size = 10, repel = TRUE, cells.highlight = doublet.cells) + 
  ggtitle(sprintf("UMAP Sample %s: All clusters, highlighted Hashtag-Doublet cells", sample.id)) +
  theme(axis.text = element_text(size=20, face = "bold"),
        axis.title = element_text(size=20, face = "bold"), 
        title = element_text(size = 20, face = "bold"),
        legend.position = "none") 
```

### Negative
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
print(sprintf("Number of Negative cells: %s", length(negative.cells)))
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
DimPlot(object = s.obj.before.remove.by.ht, reduction = "RNA_UMAP", label = TRUE, label.box = TRUE, label.size = 10, repel = TRUE, cells.highlight = negative.cells) + 
  ggtitle(sprintf("UMAP Sample %s: All clusters, highlighted Hashtag-Negative cells", sample.id)) +
  theme(axis.text = element_text(size=20, face = "bold"),
        axis.title = element_text(size=20, face = "bold"), 
        title = element_text(size = 20, face = "bold"),
        legend.position = "none") 
```

### Singlet {.tabset}

#### Hashtag 1
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
print(sprintf("Number of assigned hashtag1 cells: %s", length(ht1.cells)))
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
DimPlot(object = s.obj, reduction = "RNA_UMAP", label = TRUE, label.box = TRUE, label.size = 10, repel = TRUE, cells.highlight = ht1.cells) + 
  ggtitle(sprintf("UMAP Sample %s: All clusters, highlighted Hashtag-1 cells", sample.id)) +
  theme(axis.text = element_text(size=20, face = "bold"),
        axis.title = element_text(size=20, face = "bold"), 
        title = element_text(size = 20, face = "bold"),
        legend.position = "none") 
```

#### Hashtag 2
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
print(sprintf("Number of assigned hashtag2 cells: %s", length(ht2.cells)))
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
DimPlot(object = s.obj, reduction = "RNA_UMAP", label = TRUE, label.box = TRUE, label.size = 10, repel = TRUE, cells.highlight = ht2.cells) + 
  ggtitle(sprintf("UMAP Sample %s: All clusters, highlighted Hashtag-2 cells", sample.id)) +
  theme(axis.text = element_text(size=20, face = "bold"),
        axis.title = element_text(size=20, face = "bold"), 
        title = element_text(size = 20, face = "bold"),
        legend.position = "none") 
```

#### Hashtag 3
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
print(sprintf("Number of assigned hashtag3 cells: %s", length(ht3.cells)))
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
DimPlot(object = s.obj, reduction = "RNA_UMAP", label = TRUE, label.box = TRUE, label.size = 10, repel = TRUE, cells.highlight = ht3.cells) + 
  ggtitle(sprintf("UMAP Sample %s: All clusters, highlighted Hashtag-3 cells", sample.id)) +
  theme(axis.text = element_text(size=20, face = "bold"),
        axis.title = element_text(size=20, face = "bold"), 
        title = element_text(size = 20, face = "bold"),
        legend.position = "none")
```

## Re-run UMAP and clustering after filtering doublet-hashtag cells
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
cluster.resolution <- 0.5
chosen.assay <- "RNA"

s.obj <- RunPCA(s.obj, npcs = num.PCA, verbose = FALSE, reduction.name=sprintf("%s_PCA", chosen.assay))
  
s.obj <- RunUMAP(s.obj, reduction = sprintf("%s_PCA", chosen.assay), 
                   dims = 1:num.PC.used.in.UMAP, reduction.name=sprintf("%s_UMAP", chosen.assay),
                   seed.use = my_random_seed, umap.method = "uwot")
  
# clustering 
s.obj <- FindNeighbors(s.obj, reduction = sprintf("%s_PCA", chosen.assay), dims = 1:num.PC.used.in.Clustering)
  
s.obj <- FindClusters(s.obj, resolution = cluster.resolution, random.seed = 0)
```

## UMAP: all clusters in the sample
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
DimPlot(object = s.obj, reduction = "RNA_UMAP", label = TRUE, label.box = TRUE, label.size = 10, repel = TRUE) + 
  ggtitle(sprintf("UMAP Sample %s: All clusters", sample.id)) +
  theme(axis.text = element_text(size=20, face = "bold"),
        axis.title = element_text(size=20, face = "bold"), 
        title = element_text(size = 20, face = "bold"))
```


# Cluster marker genes

Identify differentially expressed genes in each cluster. 
```{r echo=FALSE, warning=FALSE, message=FALSE, results='hide', fig.height=10, fig.width=18}
Idents(s.obj) <- "seurat_clusters"
if (file.exists(file.path(path.to.02.output, "DE_cluster_marker_genes.rds")) == FALSE){
  DefaultAssay(s.obj) <- "RNA"
  cluster.markers <- FindAllMarkers(object = s.obj, assay = "RNA", test.use = "wilcox", slot = "data", min.pct = 0.5)
  cluster.markers <- subset(cluster.markers, cluster.markers$p_val_adj < 0.05 & cluster.markers$avg_log2FC > 0)
  saveRDS(cluster.markers, file.path(path.to.02.output, "DE_cluster_marker_genes.rds"))
} else {
  cluster.markers <- readRDS(file.path(path.to.02.output, "DE_cluster_marker_genes.rds"))
}
```

## Feature plot {.tabset}
```{r echo=FALSE, fig.height=12, fig.width=20, message=FALSE, warning=FALSE, results='asis'}
for (cluster.id in sort(unique(cluster.markers$cluster))){
  DefaultAssay(s.obj) <- "RNA"
  cat(sprintf("### Cluster %s \n", cluster.id))
  tmp.cluster.markers <- subset(cluster.markers, cluster.markers$cluster == cluster.id) %>% arrange(desc(avg_log2FC))
  p <- FeaturePlot(object = s.obj, reduction = "RNA_UMAP", features = head(tmp.cluster.markers, 9)$gene, ncol = 3, label = TRUE, pt.size = 0.5, label.size = 5, label.color = "red", slot = "data")  
  print(p)
  cat("\n \n")
}
```

## Dot plot{.tabset}
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
for (cluster.id in sort(unique(cluster.markers$cluster))){
  DefaultAssay(s.obj) <- "RNA"
  cat(sprintf("### Cluster %s \n", cluster.id))
  tmp.cluster.markers <- subset(cluster.markers, cluster.markers$cluster == cluster.id) %>% arrange(desc(avg_log2FC))
  p <- DotPlot(object = s.obj, features = head(tmp.cluster.markers, 9)$gene)  
  print(p)
  cat("\n \n")
}
```

## Violin plot{.tabset}
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
for (cluster.id in sort(unique(cluster.markers$cluster))){
  DefaultAssay(s.obj) <- "RNA"
  cat(sprintf("### Cluster %s \n", cluster.id))
  tmp.cluster.markers <- subset(cluster.markers, cluster.markers$cluster == cluster.id) %>% arrange(desc(avg_log2FC))
  p <- VlnPlot(object = s.obj, features = head(tmp.cluster.markers, 9)$gene, slot = "data")  
  print(p)
  cat("\n \n")
}
```

## Full tables of DE genes {.tabset}
```{r echo=FALSE, results='asis', include=FALSE}
cluster.markers %>% create_dt()
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
all.cluster.ids <- sort(unique(s.obj$seurat_clusters))
for (cluster.id in all.cluster.ids){
  tmp.table <- subset(cluster.markers, cluster.markers$cluster == cluster.id) %>% arrange(desc(avg_log2FC))
  cat(paste("\n\n### Cluster: ", cluster.id, "##\n"))
  print( htmltools::tagList(datatable(tmp.table, extensions = 'Buttons',
                                      filter = "top",
                                      options = list(dom = 'Blfrtip',
                                                     buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                                                     lengthMenu = list(c(10,25,50,-1),
                                                                       c(10,25,50,"All")),
                                                     columnDefs = list(list(
                                                       targets = "_all",
                                                       render = JS(
                                                         "function(data, type, row, meta) {",
                                                         "return type === 'display' && data != null && data.length > 100 ?",
                                                         "'<span title=\"' + data + '\">' + data.substr(0, 100) + '...</span>' : data;",
                                                         "}")
                                                     ))
                                      ))))
  cat("\n \n")  
}
```


# Number of cells in each cluster in each sample
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=14, fig.height=10}
cell.count.in.clusters <- table(s.obj$name, s.obj$seurat_clusters) %>% as.data.frame() %>%
  pivot_wider(names_from = "Var2", values_from = "Freq") 
cell.count.in.clusters %>% create_dt()
```

# Cell type annotation by pathway analysis with CellMarkers 2.0
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=14, fig.height=10}
library(clusterProfiler)
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=14, fig.height=10}
if ("org.Mm.eg.db" %in% installed.packages() == FALSE){
  BiocManager::install("org.Mm.eg.db")
}
library("org.Mm.eg.db")

annotate_with_pathway <- function(cluster.id, topN = 20){
  if (topN == "all"){
      tmpdf <- subset(cluster.markers, cluster.markers$cluster == cluster.id) %>% arrange(desc(avg_log2FC))
  } else {
      tmpdf <- subset(cluster.markers, cluster.markers$cluster == cluster.id) %>% arrange(desc(avg_log2FC)) %>% head(topN)    
  }

  path.to.cellmarker2.0 <- "/media/hieunguyen/HD01/storage/CellMarker2.0"
  cell_marker_data <- readxl::read_excel(file.path(path.to.cellmarker2.0, "Cell_marker_Mouse.xlsx"))
  
  ## instead of `cellName`, users can use other features (e.g. `cancerType`)
  cells <- cell_marker_data %>%
      dplyr::select(cell_name, GeneID) %>%
      dplyr::mutate(GeneID = strsplit(GeneID, ', ')) %>%
      tidyr::unnest()
  tryCatch(
    expr = {
       convertdf <- bitr(tmpdf$gene, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Mm.eg.db")
       if ("stats" %in% colnames(convertdf) == FALSE) {
         x <- enricher(convertdf$ENTREZID, TERM2GENE = cells) %>%
           as.data.frame() %>%
           subset(p.adjust <= 0.05)
         x <- x %>% subset(select = -c(geneID)) %>% arrange(desc(Count))
         } else {
           x <- data.frame(status = c("Cell type not detected"))
           }
       return(x)  
    },
    error = function(e){
        return(data.frame())
      })
}

pathway.annotation <- hash()
```

## Result tables {.tabset}
```{r echo=FALSE, results='asis', include=FALSE}
annotate_with_pathway(1) %>% create_dt()
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
annotationdf <- data.frame()
top5.annotationdf <- data.frame()

available.diff.clusters <- unique(cluster.markers$cluster)

for (cluster.id in all.cluster.ids){
  if (cluster.id %in% available.diff.clusters == FALSE){
    tmp.table <- data.frame(status = c("Cell type not detected!"))
  } else {
      tmp.table <- annotate_with_pathway(cluster.id)
  }

  if (nrow(tmp.table) == 0 | "status" %in% colnames(tmp.table)){
    tmp.table <- data.frame(status = c("Cell type not detected!"))
  } else {
      tmpdf <- data.frame(cluster.id = c(cluster.id), annotation = c(head(tmp.table, 1)$ID))
      annotationdf <- rbind(annotationdf, tmpdf)
      
      tmpdf <- data.frame(cluster.id = c(cluster.id), annotation = c(paste(head(tmp.table, 5)$ID, collapse = ", ")))
      top5.annotationdf <- rbind(top5.annotationdf, tmpdf)
    
  }
  
  cat(paste("\n\n### Cluster: ", cluster.id, "##\n"))
  print( htmltools::tagList(datatable(tmp.table, extensions = 'Buttons',
                                      filter = "top",
                                      options = list(dom = 'Blfrtip',
                                                     buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                                                     lengthMenu = list(c(10,25,50,-1),
                                                                       c(10,25,50,"All")),
                                                     columnDefs = list(list(
                                                       targets = "_all",
                                                       render = JS(
                                                         "function(data, type, row, meta) {",
                                                         "return type === 'display' && data != null && data.length > 100 ?",
                                                         "'<span title=\"' + data + '\">' + data.substr(0, 100) + '...</span>' : data;",
                                                         "}")
                                                     ))
                                      ))))
  cat("\n \n")  
}
```

## Top-1 annotation for each cluster
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
annotationdf %>% create_dt()
```

## Top-5 annotation for each clusters
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
top5.annotationdf %>% create_dt()
```

```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
meta.data <- s.obj@meta.data %>% rownames_to_column("barcode") %>%
  rowwise() %>%
  mutate(prediction2 = ifelse(nrow(subset(annotationdf, annotationdf$cluster.id == seurat_clusters)) != 0, 
                              subset(annotationdf, annotationdf$cluster.id == seurat_clusters)$annotation,
                              "None")) %>%
  column_to_rownames("barcode")
meta.data <- meta.data[row.names(s.obj@meta.data),]
s.obj <- AddMetaData(s.obj, metadata = meta.data$prediction2, col.name = "prediction2")

DimPlot(object = s.obj, reduction = "RNA_UMAP", label.box = TRUE, label = TRUE, repel = TRUE, group.by = "prediction2")
```

## Number of cells in each annotated cluster (top-1 annotation)
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
table(s.obj$prediction2, s.obj$name) %>% as.data.frame() %>% pivot_wider(names_from = "Var1", values_from = "Freq") %>% create_dt()
```


# Save objects
```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
#####----------------------------------------------------------------------#####
##### SAVE OBJECTS FOR FURTHER ANALYSIS 
#####----------------------------------------------------------------------#####
# Save the seurat object with annotations on hashtag QC
if (file.exists(file.path(path.to.02.output, sprintf("GEX_sample_%s_seurat_object.rds", sample.id))) == FALSE){
  saveRDS(object = s.obj, file = file.path(path.to.02.output, sprintf("GEX_sample_%s_seurat_object.rds", sample.id)))  
}

```


```{r echo=FALSE, warning=FALSE, message=FALSE, results='asis', fig.width=20, fig.height=12}
```